<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pass 2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-bg: #f7fafc;
            --secondary-bg: #edf2f7;
            --primary-text: #2d3748;
            --secondary-text: #4a5568;
            --accent-color: #58a0db;
            --accent-hover: #227dd1;
            --success-color: #48bb78;
            --error-color: #f56565;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #cbd5e0;
            --input-border-color: #a0aec0;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .headout {
            background-color: var(--secondary-bg);
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 6px var(--shadow-color);
        }

        h1 {
            color: var(--accent-color);
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
            transition: transform 0.3s ease;
        }

        h1:hover {
            transform: scale(1.05);
        }

        .outbox {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.7rem;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .left,
        .right {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }

        .left-box,
        .right-box {
            background-color: var(--secondary-bg);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .left-box:hover,
        .right-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        .box-header {
            background-color: var(--accent-color);
            color: white;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .box-content {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        textarea {
            width: 95%;
            height: 250px;
            background-color: white;
            color: var(--primary-text);
            border: 2px solid var(--input-border-color);
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            font-family: 'Fira Code', monospace;
            resize: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .edit-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .pen-btn,
        .download,
        .upload {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 6px;
            border-radius: 4px;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .save-btn {
            background-color: var(--success-color);
        }

        .reset-btn {
            background-color: var(--error-color);
        }

        .center {
            width: 100%;
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }

        .run-btn {
            background-color: var(--accent-color);
            color: white;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(66, 153, 225, 0.5);
            transition: all 0.3s ease;
        }

        .left {
            animation-delay: 0.2s;
        }

        .right {
            animation-delay: 0.4s;
        }

        @media (max-width: 1000px) {
            .outbox {
                flex-direction: column;
            }

            .left,
            .right {
                width: 100%;
            }

            .button-group {
                flex-wrap: wrap;
            }

            .run-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <div class="headout">
        <div class="head">
            <h1>Pass 2 Assembler</h1>
        </div>
    </div>
    <div class="outbox">
        <div class="left">
            <h2>Input</h2>
            <div class="left-box">
                <button class="input-btn">Input</button>
                <button class="optab-btn">Optab</button>

                <div class="edit-btn">
                    <p id="lname"></p>
                    <div class="saver">
                        <button class="left-download download">
                            Download
                        </button>
                    </div>
                </div>


                <textarea></textarea>
            </div>
        </div>

        <div class="center">
            <button class="run-btn">Run</button>
        </div>

        <div class="right">
            <h2>Output</h2>
            <div class="right-box">
                <button class="intermediate-btn">Intermediate File</button>
                <button class="symtab-btn">Symtab</button>
                <button class="output-btn">Output File</button>
                <button class="output2-btn">Output</button>

                <div class="edit-btn">
                    <p id="rname"></p>
                    <div class="saver">
                        <button class="reset-btn">Clear</button>
                        <button class="right-download download">
                            Download
                        </button>
                    </div>
                </div>
                <textarea readonly></textarea>
            </div>
        </div>
    </div>
    <script>
        let leftselected, rightselected, side

        document.addEventListener('DOMContentLoaded', async () => {
            leftselected = "input"
            rightselected = "intermediate"
            document.querySelector('.input-btn').click()
            document.querySelector('.intermediate-btn').click()
        })

        document.querySelector('.left-box textarea').addEventListener('input', async () => {
            const text = document.querySelector('.left-box textarea').value
            if (leftselected === "input") {
                localStorage.setItem('input.txt', text)
            } else if (leftselected === "optab") {
                localStorage.setItem('optab.txt', text)
            }
        })

        document.querySelector('.input-btn').addEventListener('click', async () => {
            document.querySelector('#lname').innerHTML = "Input File"
            leftselected = "input"
            document.querySelector('.input-btn').style.backgroundColor = "#227dd1"
            document.querySelector('.optab-btn').style.backgroundColor = "#58a0db"

            const text = localStorage.getItem('input.txt')
            if (text) {
                document.querySelector('.left-box textarea').value = text
            } else {
                document.querySelector('.left-box textarea').value = ""
            }
        })
        document.querySelector('.optab-btn').addEventListener('click', async () => {
            document.querySelector('#lname').innerHTML = "Optab File"
            leftselected = "optab"
            document.querySelector('.optab-btn').style.backgroundColor = "#227dd1"
            document.querySelector('.input-btn').style.backgroundColor = "#58a0db"

            const text = localStorage.getItem('optab.txt')
            if (text) {
                document.querySelector('.left-box textarea').value = text
            } else {
                document.querySelector('.left-box textarea').value = ""
            }
        })

        document.querySelector('.intermediate-btn').addEventListener('click', async () => {
            document.querySelector('#rname').innerHTML = "Intermediate File"
            rightselected = "intermediate"
            document.querySelector('.intermediate-btn').style.backgroundColor = "#227dd1"
            document.querySelectorAll('.symtab-btn, .output-btn, .output2-btn').forEach((btn) => {
                btn.style.backgroundColor = "#58a0db"
            })

            const text = localStorage.getItem('intermediate.txt')
            if (text) {
                document.querySelector('.right-box textarea').value = text
            } else {
                document.querySelector('.right-box textarea').value = ""
            }
        })
        document.querySelector('.symtab-btn').addEventListener('click', async () => {
            document.querySelector('#rname').innerHTML = "Symtab File"
            rightselected = "symtab"
            document.querySelector('.symtab-btn').style.backgroundColor = "#227dd1"
            document.querySelectorAll('.intermediate-btn, .output-btn, .output2-btn').forEach((btn) => {
                btn.style.backgroundColor = "#58a0db"
            })

            const text = localStorage.getItem('symtab.txt')
            if (text) {
                document.querySelector('.right-box textarea').value = text
            } else {
                document.querySelector('.right-box textarea').value = ""
            }
        })
        document.querySelector('.output-btn').addEventListener('click', async () => {
            document.querySelector('#rname').innerHTML = "Output File"
            rightselected = "output"
            document.querySelector('.output-btn').style.backgroundColor = "#227dd1"
            document.querySelectorAll('.intermediate-btn, .symtab-btn, .output2-btn').forEach((btn) => {
                btn.style.backgroundColor = "#58a0db"
            })

            const text = localStorage.getItem('output.txt')
            if (text && text !== "") {
                document.querySelector('.right-box textarea').value = text
            } else {
                document.querySelector('.right-box textarea').value = ""
            }
        })
        document.querySelector('.output2-btn').addEventListener('click', async () => {
            document.querySelector('#rname').innerHTML = "Output Code"
            rightselected = "output2"
            document.querySelector('.output2-btn').style.backgroundColor = "#227dd1"
            document.querySelectorAll('.intermediate-btn, .symtab-btn, .output-btn').forEach((btn) => {
                btn.style.backgroundColor = "#58a0db"
            })

            const text = localStorage.getItem('output2.txt')
            if (text && text !== "") {
                document.querySelector('.right-box textarea').value = text
            } else {
                document.querySelector('.right-box textarea').value = ""
            }
        })

        document.querySelector('.left-download').addEventListener('click', async function () {
            side = "left"
        })
        document.querySelector('.right-download').addEventListener('click', async function () {
            side = "right"
        })
        document.querySelectorAll('.download').forEach(element => {
            element.addEventListener('click', async function () {
                let fileName
                if (side === "left") {
                    leftselected === "input" ? fileName = 'input.txt' : fileName = 'optab.txt'
                } else if (side === "right") {
                    if (rightselected === "intermediate") {
                        fileName = 'intermediate.txt'
                    } else if (rightselected === "symtab") {
                        fileName = 'symtab.txt'
                    } else if (rightselected === "output") {
                        fileName = 'output.txt'
                    } else if (rightselected === "output2") {
                        fileName = 'output2.txt'
                    }

                }
                const text = localStorage.getItem(fileName)

                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'Text Files',
                            accept: { 'text/plain': ['.txt'] },
                        }],
                    })

                    const writable = await handle.createWritable()
                    await writable.write(text)
                    await writable.close()
                } catch (error) {
                }
            })
        })

        document.querySelector('.reset-btn').addEventListener('click', async () => {
            const result = confirm('Do you want to clear both the files?')
            if (result) {
                document.querySelector('.left-box textarea').value = ""
                document.querySelector('.right-box textarea').value = ""
                localStorage.clear()
            }
        })

        document.querySelector('.run-btn').addEventListener('click', async () => {
            const inputString = localStorage.getItem('input.txt')
            const optabString = localStorage.getItem('optab.txt')

            if (!inputString || !optabString) {
                alert('Please upload both the files.')
                return
            }

            const inputArr = inputString.split('\n')
            for (let i = 0; i < inputArr.length; i++) {
                inputArr[i] = inputArr[i].trim().split(/\s+/)
            }
            const optabArr = optabString.split('\n')
            for (let i = 0; i < optabArr.length; i++) {
                optabArr[i] = optabArr[i].trim().split(/\s+/)
            }
            const pass1out = pass1(inputArr, optabArr)
            localStorage.setItem('intermediate.txt', pass1out.intermediate)
            localStorage.setItem('symtab.txt', pass1out.symtab)

            const intermediateArr = pass1out.intermediate.split('\n')
            for (let i = 0; i < intermediateArr.length; i++) {
                intermediateArr[i] = intermediateArr[i].trim().split(/\s+/)
            }
            const symtabArr = pass1out.symtab.split('\n')
            for (let i = 0; i < symtabArr.length; i++) {
                symtabArr[i] = symtabArr[i].trim().split(/\s+/)
            }
            const pass2out = pass2(optabArr, intermediateArr, symtabArr)
            localStorage.setItem('output.txt', pass2out.output)
            localStorage.setItem('output2.txt', pass2out.output2)
            document.querySelector('.' + leftselected + '-btn').click()
            document.querySelector('.' + rightselected + '-btn').click()
        })

        function pass1(inputArr, optabArr) {
            let locctr = 0, i = 1, prev, top = 0, pos = -1
            let interAddr = []
            const symtabArr = [[]]
            let opcode
            let intermediate = "", symtab = ""
            if (inputArr[0][1] === 'START') {
                locctr = parseInt(inputArr[0][2], 16)
                prev = locctr
            } else {
                locctr = 0
            }

            while (inputArr[i][1] !== 'END') {
                let found = false
                opcode = inputArr[i][1]
                for (let x = 0; x < optabArr.length; x++) {
                    if (optabArr[x][0] === opcode) {
                        locctr += 3
                        found = true
                        break
                    }
                }
                if (!found) {
                    if (inputArr[i][1] === 'WORD') {
                        locctr += 3
                    }
                    else if (inputArr[i][1] === 'RESW') {
                        locctr += 3 * parseInt(inputArr[i][2])

                    }
                    else if (inputArr[i][1] === 'RESB') {
                        locctr += parseInt(inputArr[i][2])

                    }
                    else if (inputArr[i][1] === 'BYTE') {
                        const len = inputArr[i][2].length
                        locctr += len - 3

                    }
                    else {
                        console.log("Invalid opcode")
                    }
                }
                top++
                interAddr[top] = prev.toString(16)
                i++
                prev = locctr

                //symtab
                if (inputArr[i][0] !== '-') {
                    let flag = 0
                    for (let x = 0; x < symtabArr.length; x++) {
                        if (symtabArr[x][0] === inputArr[i][0]) {
                            flag = 1
                            symtabArr[x][2] = 1
                        }
                    }
                    pos++
                    symtabArr[pos] = ([inputArr[i][0], prev.toString(16), flag])
                }
            }
            top++
            interAddr[top] = prev.toString(16)

            intermediate = "-\t" + inputArr[0][0] + "\t" + inputArr[0][1] + "\t" + inputArr[0][2] + "\n"
            for (let j = 1; j < interAddr.length; j++) {
                intermediate += interAddr[j] + "\t" + inputArr[j][0] + "\t" + inputArr[j][1] + "\t" + inputArr[j][2] + "\n"
            }
            intermediate = intermediate.slice(0, -1)

            for (let j = 0; j < symtabArr.length; j++) {
                symtab += symtabArr[j][0] + "\t" + symtabArr[j][1] + "\t" + symtabArr[j][2] + "\n"
            }
            symtab = symtab.slice(0, -1)

            return { intermediate, symtab }
        }

        function pass2(optabArr, intermediateArr, symtabArr) {
            let i = 1, objectCode
            let objectCodeArr = []

            while (intermediateArr[i][2] !== 'END') {
                let found = false
                optabArr.forEach((opLine) => {
                    if (opLine[0] === intermediateArr[i][2]) {
                        found = true
                        objectCode = opLine[1]
                        symtabArr.forEach((symLine) => {
                            if (symLine[0] === intermediateArr[i][3]) {
                                objectCode += symLine[1]
                                objectCodeArr.push(objectCode)
                            }
                        })
                    }
                })

                if (!found) {
                    if (intermediateArr[i][2] === 'WORD') {
                        const val = parseInt(intermediateArr[i][3])
                        objectCode = val.toString(16).padStart(6, '0')
                        objectCodeArr.push(objectCode)
                    }
                    else if (intermediateArr[i][2] === 'BYTE') {
                        const val = intermediateArr[i][3].substring(2, intermediateArr[i][3].length - 1)
                        objectCode = ""
                        for (let char of val) {
                            objectCode += char.charCodeAt(0).toString(16)
                        }
                        objectCodeArr.push(objectCode)
                    }
                    else if (intermediateArr[i][2] === 'RESW' || intermediateArr[i][2] === 'RESB') {
                        objectCode = "\t"
                        objectCodeArr.push(objectCode)
                    }
                }
                i++
            }
            objectCodeArr.push("\t")

            let output = intermediateArr[0][0] + "\t" + intermediateArr[0][1] + "\t" + intermediateArr[0][2] + "\t" + intermediateArr[0][3] + "\n"
            for (let j = 1; j < intermediateArr.length; j++) {
                output += intermediateArr[j][0] + "\t" + intermediateArr[j][1] + "\t" + intermediateArr[j][2] + "\t" + intermediateArr[j][3] + "\t" + objectCodeArr[j - 1] + "\n"
            }
            const lower = parseInt(intermediateArr[1][0], 16)
            const upper = parseInt(intermediateArr[intermediateArr.length - 1][0], 16)
            const length = upper - lower
            let output2 = "H^" + intermediateArr[0][1].padEnd(6, "_") + "^" + intermediateArr[1][0] + "^" + length.toString(16).padStart(6, "0") + "\n\n"
            let lines = intermediateArr.length - 1, x = 1, text = "", size = 0, found = false
            let start = intermediateArr[x][0]
            while (x < intermediateArr.length) {
                found = false
                if (objectCodeArr[x - 1] === "\t") {
                    x++
                    continue
                }
                text += "^" + objectCodeArr[x - 1]
                size += objectCodeArr[x - 1].length / 2
                if (size > 21) {
                    found = true
                    size -= objectCodeArr[x - 1].length / 2
                    text = text.slice(0, -objectCodeArr[x - 1].length - 1)
                    output2 += "T^" + start + "^" + size.toString(16).padStart(2, "0") + text + "\n"
                    start = intermediateArr[x][0]
                    text = ""
                    size = 0
                    continue
                }
                x++
            }
            if (!found) {
                output2 += "T^" + start + "^" + size.toString(16).padStart(2, "0") + text + "\n\n"
            }

            output2 += "E^" + intermediateArr[1][0]

            symtabArr.forEach((symLine) => {
                if (symLine[2] == 1) {
                    output = ""
                    output2 = ""
                }
            })

            return { output, output2 }
        }
    </script>
</body>

</html>